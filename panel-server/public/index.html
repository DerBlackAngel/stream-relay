<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stream Relay Panel</title>
  <style>
    :root{ color-scheme: dark; }
    body{ margin:0; font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; background:#0b0f14; color:#e9eef6; }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 18px; }
    h1{ font-size: 18px; margin: 0 0 12px; font-weight: 700; }
    .grid{ display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width: 900px){ .grid{ grid-template-columns: 1fr 1fr; } }

    .card{ background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); border-radius: 14px; padding: 14px; }
    .row{ display:flex; align-items:center; justify-content: space-between; gap: 12px; padding: 10px 0; border-bottom:1px solid rgba(255,255,255,0.08); }
    .row:last-child{ border-bottom:0; }

    .name{ display:flex; align-items:center; gap:10px; font-weight: 650; }
    .dot{ width:10px; height:10px; border-radius:999px; background:#777; box-shadow: 0 0 0 3px rgba(255,255,255,0.05) inset; }
    .dot.on{ background:#2bd576; }
    .dot.off{ background:#ff4d6d; }

    .meta{ opacity: 0.8; font-size: 12px; }
    .btns{ display:flex; flex-wrap: wrap; gap: 10px; }
    button{
      appearance:none; border:1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color:#e9eef6; border-radius: 12px;
      padding: 10px 12px; cursor:pointer; font-weight: 650;
    }
    button:hover{ background: rgba(255,255,255,0.10); }
    button:disabled{ opacity:0.55; cursor:not-allowed; }

    .big{ font-size: 13px; line-height: 1.35; white-space: pre-wrap; word-break: break-word; }
    .label{ font-size: 12px; opacity:0.75; margin-bottom: 8px; }
    .current{ font-weight: 700; }
    .warn{ color:#ffcf5a; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Stream Relay Panel</h1>

    <div class="grid">
      <div class="card">
        <div class="label">Quellen-Status (RTMP Eingänge)</div>

        <div class="row">
          <div class="name"><span id="d_dennis" class="dot off"></span> Dennis</div>
          <div class="meta" id="m_dennis">–</div>
        </div>

        <div class="row">
          <div class="name"><span id="d_auria" class="dot off"></span> Freundin</div>
          <div class="meta" id="m_auria">–</div>
        </div>

        <div class="row">
          <div class="name"><span id="d_mobil" class="dot off"></span> Mobil</div>
          <div class="meta" id="m_mobil">–</div>
        </div>

        <div class="meta" style="margin-top:10px">
          Grün = Publisher aktiv. Rot = keine Quelle. Zahlen zeigen nclients und bytes_in.
        </div>
      </div>

      <div class="card">
        <div class="label">Ausgabe (Twitch Push)</div>
        <div style="margin-bottom:10px">
          Aktuell aktiv: <span id="current" class="current">–</span>
          <span id="curNote" class="meta"></span>
        </div>

        <div class="btns">
          <button id="b_dennis" onclick="switchTo('dennis')">→ Twitch: Dennis</button>
          <button id="b_auria" onclick="switchTo('auria')">→ Twitch: Freundin</button>
          <button id="b_mobil" onclick="switchTo('mobil')">→ Twitch: Mobil</button>
          <button id="b_brb" onclick="switchTo('brb')">→ Twitch: BRB</button>
          <button id="b_stop" onclick="stopPush()">Stop</button>
        </div>

        <div class="meta" style="margin-top:10px">
          Beim Umschalten sperren wir 2 Sekunden gegen Doppelklicks.
        </div>
      </div>

      <div class="card">
        <div class="label">FFmpeg Kommando (laut /api/current)</div>
        <div id="cmd" class="big">(lade …)</div>
      </div>

      <div class="card">
        <div class="label">Log-Ausschnitt Twitch-Push (letzte 20 Zeilen)</div>
        <div id="log" class="big">(lade …)</div>
        <div id="logWarn" class="meta warn" style="display:none; margin-top:10px">
          Kein Log verfügbar. Falls dauerhaft leer: läuft twitch-push nicht, oder Docker-Logs sind leer.
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function setDot(id, on){
    const el = $(id);
    el.classList.remove("on","off");
    el.classList.add(on ? "on" : "off");
  }

  function fmtMeta(s){
    const n = s?.nclients ?? 0;
    const bi = s?.bytesIn ?? 0;
    return `nclients=${n}, bytes_in=${bi}`;
  }

  let lock = false;
  function lockButtons(ms=2000){
    lock = true;
    ["b_dennis","b_auria","b_mobil","b_brb","b_stop"].forEach(id => $(id).disabled = true);
    setTimeout(() => {
      lock = false;
      ["b_dennis","b_auria","b_mobil","b_brb","b_stop"].forEach(id => $(id).disabled = false);
    }, ms);
  }

  async function switchTo(src){
    if (lock) return;
    lockButtons(2000);
    await fetch("/api/switch", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ source: src })
    }).catch(()=>{});
    await refreshAll();
  }

  async function stopPush(){
    if (lock) return;
    lockButtons(1500);
    await fetch("/api/stop", { method:"POST" }).catch(()=>{});
    await refreshAll();
  }

  async function refreshStatus(){
    const j = await fetch("/api/status").then(r=>r.json()).catch(()=>null);
    if (!j?.ok) return;

    const s = j.stat || {};
    setDot("d_dennis", !!s.dennis?.publisher);
    setDot("d_auria",  !!s.auria?.publisher);
    setDot("d_mobil",  !!s.mobil?.publisher);

    $("m_dennis").textContent = fmtMeta(s.dennis);
    $("m_auria").textContent  = fmtMeta(s.auria);
    $("m_mobil").textContent  = fmtMeta(s.mobil);
  }

  async function refreshCurrent(){
    const j = await fetch("/api/current").then(r=>r.json()).catch(()=>null);
    if (!j?.ok) return;

    $("current").textContent = j.mode || "–";
    $("curNote").textContent = j.mode === "unknown" ? " (unbekannt)" : "";

    $("cmd").textContent = (j.cmd && j.cmd.trim()) ? j.cmd.trim() : "(keine Daten)";
  }

  async function refreshLogtail(){
    const t = await fetch("/api/logtail?lines=20").then(r=>r.text()).catch(()=> "");
    $("log").textContent = t && t.trim() ? t.trim() : "(leer)";
    $("logWarn").style.display = (t && t.trim()) ? "none" : "block";
  }

  async function refreshAll(){
    await Promise.allSettled([refreshStatus(), refreshCurrent(), refreshLogtail()]);
  }

  refreshAll();
  setInterval(refreshStatus, 3000);
  setInterval(refreshCurrent, 3000);
  setInterval(refreshLogtail, 3000);
</script>
</body>
</html>
