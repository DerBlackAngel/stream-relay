<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>Stream Relay – Panel</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #141a22;
      --muted: #8aa0b4;
      --fg: #e8f0f7;
      --ok: #3ddc97;
      --warn: #ffbf69;
      --err: #ff6b6b;
      --accent: #5ab0ff;
      --btn: #1e2630;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--fg);
      font: 500 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .wrap { max-width: 980px; margin: 0 auto; padding: 20px; }
    .row { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 720px) { .row { grid-template-columns: 1fr 1fr; } }
    .card {
      background: var(--card); border-radius: 14px; padding: 16px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.03);
    }
    .header {
      display: flex; gap: 12px; align-items: center; justify-content: space-between;
      margin-bottom: 16px;
    }
    .badge {
      display: inline-flex; align-items: center; gap: 8px;
      background: #0f1620; border: 1px solid #1f2a37; border-radius: 999px;
      padding: 8px 12px; color: var(--muted);
    }
    .badge b { color: var(--fg); }
    .btns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    button {
      background: var(--btn); color: var(--fg);
      border: 1px solid #2a3746; border-radius: 12px; padding: 12px;
      cursor: pointer; transition: transform .02s ease, background .2s ease, opacity .2s ease;
    }
    button:hover { background: #232c38; transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .hint { color: var(--muted); font-size: 13px; margin-top: 8px; }
    pre {
      background: #0f1620; color: #d8e4ef; border: 1px solid #1f2a37;
      border-radius: 12px; padding: 12px; overflow: auto; max-height: 360px;
      white-space: pre-wrap; word-break: break-word;
    }
    .ok   { color: var(--ok); }
    .warn { color: var(--warn); }
    .err  { color: var(--err); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .grid2 { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 720px) { .grid2 { grid-template-columns: 1fr 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="badge">
          <span>Aktuell aktiv:</span>
          <b id="currentMode">–</b>
        </div>
        <small class="hint mono" id="statusHint">—</small>
      </div>

      <div class="btns">
        <button id="btn-dennis" data-source="dennis">Dennis</button>
        <button id="btn-auria"  data-source="auria">Freundin</button>
        <button id="btn-mobil"  data-source="mobil">Mobil</button>
        <button id="btn-brb"    data-source="brb">BRB</button>
      </div>
      <div class="hint">Beim Umschalten sind die Buttons für 2 Sekunden gesperrt (gegen Doppelklicks).</div>
    </div>

    <div class="row" style="margin-top:16px;">
      <div class="card">
        <h3 style="margin:0 0 10px;">FFmpeg Kommando (Server → Twitch)</h3>
        <pre id="cmdBox">(lade …)</pre>
        <div class="hint">Dies ist das aktuell laufende Kommando laut <span class="mono">/api/current</span>.</div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 10px;">Log-Ausschnitt Twitch-Push (letzte 20 Zeilen)</h3>
        <pre id="logBox">Noch kein Log verfügbar.
– Falls hier nichts auftaucht, ist der Log-Endpoint <span class="mono">/api/logtail</span> noch nicht aktiviert.
– Wir schalten ihn im nächsten Schritt auf dem Server frei.</pre>
        <div class="hint">Die Box aktualisiert sich alle 3 Sekunden, falls der Endpoint vorhanden ist.</div>
      </div>
    </div>
  </div>

  <script>
    const $mode = document.getElementById('currentMode');
    const $hint = document.getElementById('statusHint');
    const $cmd  = document.getElementById('cmdBox');
    const $log  = document.getElementById('logBox');
    const btns  = [...document.querySelectorAll('button[data-source]')];

    let busy = false;
    let lastMode = null;

    async function getJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    function setBusy(on) {
      busy = on;
      btns.forEach(b => b.disabled = on);
      $hint.textContent = on ? 'Umschalten …' : 'Bereit';
    }

    async function refresh() {
      try {
        const j = await getJSON('/api/current');
        const mode = j?.mode || '–';
        $mode.textContent = mode;
        $cmd.textContent = j?.cmd ? j.cmd : '(kein Kommando / inaktiv)';

        if (mode !== lastMode) {
          lastMode = mode;
          // kurze optische Bestätigung
          $hint.textContent = `Aktiv: ${mode}`;
          setTimeout(() => { if (!busy) $hint.textContent = 'Bereit'; }, 1200);
        }
      } catch (e) {
        $mode.textContent = 'unbekannt';
        $cmd.textContent = `Fehler beim Laden von /api/current: ${e.message || e}`;
      }
    }

    async function refreshLog() {
      try {
        const res = await fetch('/api/logtail?lines=20');
        if (!res.ok) {
          if (res.status === 404) {
            // Backend-Endpoint (noch) nicht vorhanden → stiller Hinweis
            return;
          }
          throw new Error(`HTTP ${res.status}`);
        }
        const txt = await res.text();
        if (txt && txt.trim().length) $log.textContent = txt;
      } catch (_) {
        /* still halten; UI soll nicht nerven */
      }
    }

    async function doSwitch(source) {
      if (busy) return;
      setBusy(true);
      try {
        const res = await fetch('/api/switch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source })
        });
        const j = await res.json().catch(() => ({}));
        if (!res.ok || !j.ok) {
          throw new Error(`Switch fehlgeschlagen (${res.status})`);
        }
        $hint.textContent = `Geschaltet auf: ${source}`;
      } catch (e) {
        $hint.textContent = `Fehler: ${e.message || e}`;
      } finally {
        setTimeout(() => setBusy(false), 2000); // 2s Debounce
        refresh(); // frische Daten holen
      }
    }

    btns.forEach(b => b.addEventListener('click', () => doSwitch(b.dataset.source)));

    // Polling
    refresh();
    setInterval(refresh, 2000);
    setInterval(refreshLog, 3000);
  </script>
</body>
</html>
